<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>Painel de Apostas ‚Äî Quem Matou Odete Roitman?</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{
  --bg:#0b1220;--card:#0f172a;--ink:#e5f0ff;--muted:#a8b3c7;
  --line:#243043;--teal:#06b6d4;--blue:#4f46e5;
  --green:#16a34a;--red:#ef4444;--amber:#f59e0b;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui;background:var(--bg);color:var(--ink);}
header{text-align:center;padding:20px;background:var(--card);border-bottom:2px solid var(--line);}
header h1{color:var(--amber);margin:0;font-size:28px}
header p{color:var(--muted);margin:6px 0 0}
main{padding:20px;max-width:1200px;margin:auto}

/* ===== CARDS ===== */
.stats{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
  gap:12px;margin-bottom:30px;
}
.stat{
  background:var(--card);
  padding:14px;border-radius:14px;text-align:center;
  border:1px solid var(--line);
  box-shadow:0 4px 10px rgba(0,0,0,0.25);
}
.stat h3{margin:0;color:var(--muted);font-size:13px}
.stat .val{font-size:22px;font-weight:800;margin-top:6px;color:var(--amber)}

/* ===== TABELA ===== */
.table-box{
  background:var(--card);border-radius:14px;padding:16px;
  border:1px solid var(--line);overflow-x:auto;
}
.table-box table{min-width:800px;border-collapse:collapse;color:var(--ink);font-size:14px;}
th,td{padding:10px 8px;border-bottom:1px solid var(--line);text-align:left;white-space:nowrap;}
th{color:var(--muted);font-size:13px;text-transform:uppercase;background:#111827;position:sticky;top:0;z-index:1;}
td small{color:var(--muted);font-size:12px}
.btn{border:none;padding:6px 10px;border-radius:8px;cursor:pointer;font-size:13px;transition:.3s;}
.btn:disabled{opacity:0.6;cursor:default;}
.aprovar{background:var(--green);color:#fff;}
.aprovar.done{background:#1e293b;color:var(--muted);}
.reenviar{background:var(--blue);color:#fff;margin-left:6px;}
.reenviar.sent{background:#1e293b;color:var(--muted);}

/* ===== GRAFICO ===== */
.chart-box{background:var(--card);padding:16px;border-radius:14px;border:1px solid var(--line);margin-top:30px;}

/* ===== OVERLAY ===== */
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:9999;
  justify-content:center;align-items:center;flex-direction:column;}
.spinner{width:70px;height:70px;border:6px solid var(--line);
  border-top-color:var(--amber);border-radius:50%;animation:spin 1s linear infinite;}
@keyframes spin{100%{transform:rotate(360deg)}}
.overlay p{margin-top:18px;color:var(--muted);font-size:16px}

/* ===== MOBILE ===== */
@media(max-width:768px){
  header h1{font-size:22px}
  .stats{grid-template-columns:repeat(2,1fr);}
  th,td{font-size:12px}
  main{padding:12px}
  .table-box{overflow-x:auto}
  table{min-width:700px}
}
</style>
</head>
<body>
<div class="overlay" id="overlay">
  <div class="spinner"></div>
  <p>Carregando dados...</p>
</div>

<header>
  <h1>Quem Matou Odete Roitman?</h1>
  <p>Painel de Controle e An√°lise de Apostas</p>
</header>

<main>
  <section class="stats">
    <div class="stat"><h3>Total de Apostas</h3><div class="val" id="totalApostas">0</div></div>
    <div class="stat"><h3>Valor Arrecadado</h3><div class="val" id="valorArrecadado">R$ 0,00</div></div>
    <div class="stat"><h3>Pr√™mio (75%)</h3><div class="val" id="premio">R$ 0,00</div></div>
    <div class="stat"><h3>Lucro (25%)</h3><div class="val" id="lucro">R$ 0,00</div></div>
  </section>

  <section class="table-box">
    <h2 style="color:var(--amber);margin-top:0;">üìã Apostas Registradas</h2>
    <table id="tabelaApostas">
      <thead>
        <tr>
          <th>Nome</th>
          <th>E-mail</th>
          <th>Suspeito</th>
          <th>Cotas</th>
          <th>Valor</th>
          <th>Status</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section class="chart-box">
    <h2 style="color:var(--amber);margin-top:0;">üìä Apostas por Suspeito</h2>
    <canvas id="chartApostas" height="120"></canvas>
  </section>
</main>

<script>
const SCRIPT_URL="https://script.google.com/macros/s/AKfycbw3KdLZ_ao7i-2Be_yyibWcOrOT1tUkqTVVKdZ8XaZJ0cvHI5feoh-qlTVdIKvWHTHC/exec";  // substitua pelo link do GAS implantado
const PRECO=5;
let apostas=[];
const overlay=document.getElementById("overlay");

function showOverlay(msg="Carregando..."){
  overlay.style.display="flex";
  overlay.querySelector("p").textContent=msg;
}
function hideOverlay(){overlay.style.display="none";}
const fmt=v=>"R$ "+Number(v).toFixed(2).replace('.',',');

/* ===== INDICADORES ===== */
function atualizarIndices(){
  const totalApostas=apostas.length;
  const valorTotal=apostas.reduce((t,a)=>t+a.qtd*PRECO,0);
  document.getElementById("totalApostas").textContent=totalApostas;
  document.getElementById("valorArrecadado").textContent=fmt(valorTotal);
  document.getElementById("premio").textContent=fmt(valorTotal*0.75);
  document.getElementById("lucro").textContent=fmt(valorTotal*0.25);
}

/* ===== TABELA ===== */
function renderTabela(){
  const tbody=document.querySelector("#tabelaApostas tbody");
  tbody.innerHTML="";
  apostas.forEach((a,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${a.nome}</td>
      <td>${a.email||'-'}</td>
      <td>${a.foto}</td>
      <td>${a.qtd}</td>
      <td>${fmt(a.qtd*PRECO)}</td>
      <td>${a.status}</td>
      <td>
        <button class="btn aprovar ${a.status==='APROVADO'?'done':''}" data-i="${i}">
          ${a.status==='APROVADO'?'‚úîÔ∏è':'Aprovar'}
        </button>
        ${a.status!=='APROVADO'?`<button class="btn reenviar" data-i="${i}">üìß Reenviar</button>`:''}
      </td>`;
    tbody.appendChild(tr);
  });

  /* === Bot√µes Aprovar === */
  document.querySelectorAll(".aprovar").forEach(btn=>{
    btn.addEventListener("click",async()=>{
      const i=btn.dataset.i;
      if(apostas[i].status==='APROVADO')return;
      showOverlay("Aprovando aposta...");
      apostas[i].status='APROVADO';
      btn.textContent='‚úîÔ∏è';
      btn.classList.add("done");
      atualizarIndices();renderGrafico();
      await fetch(SCRIPT_URL,{
        method:"POST",
        headers:{"Content-Type":"text/plain;charset=utf-8"},
        body:JSON.stringify({...apostas[i],action:"atualizarstatus"})
      });
      hideOverlay();
    });
  });

  /* === Bot√µes Reenviar === */
  document.querySelectorAll(".reenviar").forEach(btn=>{
    btn.addEventListener("click",async()=>{
      const i=btn.dataset.i;
      const aposta=apostas[i];
      showOverlay("Reenviando e-mail...");
      const res=await fetch(SCRIPT_URL,{
        method:"POST",
        headers:{"Content-Type":"text/plain;charset=utf-8"},
        body:JSON.stringify({...aposta,action:"reenviaremail"})
      });
      hideOverlay();
      if(res.ok){
        btn.textContent='üì® Enviado';
        btn.classList.add('sent');
        btn.disabled=true;
        alert("E-mail reenviado para " + aposta.email);
      }else alert("Falha ao reenviar o e-mail.");
    });
  });
}

/* ===== GR√ÅFICO ===== */
let chart;
function renderGrafico(){
  const ctx=document.getElementById("chartApostas").getContext("2d");
  const contagem={};
  apostas.forEach(a=>{contagem[a.foto]=(contagem[a.foto]||0)+a.qtd;});
  const labels=Object.keys(contagem);
  const data=Object.values(contagem);
  if(chart)chart.destroy();
  chart=new Chart(ctx,{
    type:"bar",
    data:{labels,datasets:[{data,backgroundColor:"#f59e0b"}]},
    options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
  });
}

/* ===== CARREGAR ===== */
async function carregar(){
  showOverlay();
  try{
    const r=await fetch(`${SCRIPT_URL}?action=listar`,{cache:"no-store"});
    const j=await r.json();
    apostas=j.map(l=>({
      nome:l.nome,email:l.email,telefone:l.telefone,
      foto:l.foto,qtd:Number(l.qtd),status:l.status
    }));
    atualizarIndices();
    renderTabela();
    renderGrafico();
  }catch(e){console.error(e);}
  finally{hideOverlay();}
}
carregar();
</script>
</body>
</html>
