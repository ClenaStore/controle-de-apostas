<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>Painel de Apostas ‚Äî Quem Matou Odete Roitman?</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{
  --bg:#0b1220;--card:#0f172a;--ink:#e5f0ff;--muted:#a8b3c7;
  --line:#243043;--teal:#06b6d4;--blue:#4f46e5;
  --green:#16a34a;--red:#ef4444;--amber:#f59e0b;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui;background:var(--bg);color:var(--ink);}
header{text-align:center;padding:20px;background:var(--card);border-bottom:2px solid var(--line);}
header h1{color:var(--amber);margin:0;font-size:28px}
header p{color:var(--muted);margin:6px 0 0}
main{padding:20px;max-width:1200px;margin:auto}

/* ===== CARDS ===== */
.stats{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
  gap:12px;margin-bottom:30px;
}
.stat{
  background:var(--card);
  padding:14px;border-radius:14px;text-align:center;
  border:1px solid var(--line);
  box-shadow:0 4px 10px rgba(0,0,0,0.25);
}
.stat h3{margin:0;color:var(--muted);font-size:13px}
.stat .val{font-size:22px;font-weight:800;margin-top:6px;color:var(--amber)}

/* ===== TABELA ===== */
.table-box{
  background:var(--card);border-radius:14px;padding:16px;
  border:1px solid var(--line);overflow-x:auto;
}
.table-box table{min-width:900px;border-collapse:collapse;color:var(--ink);font-size:14px;}
th,td{padding:10px 8px;border-bottom:1px solid var(--line);text-align:left;white-space:nowrap;}
th{color:var(--muted);font-size:13px;text-transform:uppercase;background:#111827;position:sticky;top:0;z-index:1;}
td small{color:var(--muted);font-size:12px}
.btn{border:none;padding:6px 10px;border-radius:8px;cursor:pointer;font-size:13px;transition:.3s;}
.btn:disabled{opacity:0.6;cursor:default;}
.aprovar{background:var(--green);color:#fff;}
.aprovar.done{background:#1e293b;color:var(--muted);}
.reenviar{background:var(--blue);color:#fff;margin-left:6px;}
.reenviar.sent{background:#1e293b;color:var(--muted);}
.whats{background:#25D366;color:#fff;margin-left:6px;}

/* ===== GRAFICO ===== */
.chart-box{background:var(--card);padding:16px;border-radius:14px;border:1px solid var(--line);margin-top:30px;}

/* ===== RESULTADOS ===== */
.resultados{
  margin-top:40px;background:linear-gradient(135deg,var(--blue),var(--teal));
  border-radius:14px;padding:24px;color:#fff;box-shadow:0 8px 16px rgba(0,0,0,0.3);
}
.resultados h2{margin-top:0;font-size:22px;text-align:center;}
.resultados table{width:100%;border-collapse:collapse;margin-top:12px;color:#fff;}
.resultados th, .resultados td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.2);text-align:left;}
.resultados th{font-size:13px;text-transform:uppercase;color:#dbeafe;}
.resultados td:last-child{text-align:right;}
.resumoValores{display:flex;justify-content:space-around;margin-top:18px;flex-wrap:wrap;gap:16px;}
.resumoValores div{background:rgba(0,0,0,0.25);padding:10px 16px;border-radius:10px;font-weight:600;text-align:center;}

/* ===== OVERLAY ===== */
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:9999;
  justify-content:center;align-items:center;flex-direction:column;}
.spinner{width:70px;height:70px;border:6px solid var(--line);
  border-top-color:var(--amber);border-radius:50%;animation:spin 1s linear infinite;}
@keyframes spin{100%{transform:rotate(360deg)}}
.overlay p{margin-top:18px;color:var(--muted);font-size:16px}

/* ===== MOBILE ===== */
@media(max-width:768px){
  header h1{font-size:22px}
  .stats{grid-template-columns:repeat(2,1fr);}
  th,td{font-size:12px}
  main{padding:12px}
  .table-box{overflow-x:auto}
  table{min-width:700px}
}
</style>
</head>
<body>
<div class="overlay" id="overlay">
  <div class="spinner"></div>
  <p>Carregando dados...</p>
</div>

<header>
  <h1>Quem Matou Odete Roitman?</h1>
  <p>Painel de Controle e An√°lise de Apostas</p>
</header>

<main>
  <section class="stats">
    <div class="stat"><h3>Total de Apostas</h3><div class="val" id="totalApostas">0</div></div>
    <div class="stat"><h3>Valor Arrecadado</h3><div class="val" id="valorArrecadado">R$ 0,00</div></div>
    <div class="stat"><h3>Pr√™mio (75%)</h3><div class="val" id="premio">R$ 0,00</div></div>
    <div class="stat"><h3>Lucro (25%)</h3><div class="val" id="lucro">R$ 0,00</div></div>
  </section>

  <section class="table-box">
    <h2 style="color:var(--amber);margin-top:0;">Apostas Registradas</h2>
    <table id="tabelaApostas">
      <thead>
        <tr>
          <th>Nome</th>
          <th>Telefone</th>
          <th>Suspeito</th>
          <th>Cotas</th>
          <th>Valor</th>
          <th>Status</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section class="chart-box">
    <h2 style="color:var(--amber);margin-top:0;">Apostas por Suspeito</h2>
    <canvas id="chartApostas" height="120"></canvas>
  </section>

  <!-- RESULTADOS -->
  <section class="resultados" id="resultadoFinal" style="display:none;">
    <h2>üí∞ Resultado Final e Repasses</h2>
    <div class="resumoValores">
      <div>Total Arrecadado: <span id="resTotal">R$ 0,00</span></div>
      <div>Valor para Repasses (75%): <span id="resRepasses">R$ 0,00</span></div>
      <div>Lucro: <span id="resLucro">R$ 0,00</span></div>
    </div>

    <table id="tabelaGanhadores">
      <thead>
        <tr>
          <th>Nome</th>
          <th>Cotas</th>
          <th>Valor Investido</th>
          <th>Valor a Receber</th>
          <th>% Retorno</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>
</main>

<script>
const SCRIPT_URL="https://script.google.com/macros/s/AKfycbw6ffyPNYEZqbRLo-ov7maEciyqw-4QZggFw5dVqJal-qsC6gs-Go2k4v8kHh4aHgs5/exec";
const PRECO=5;
let apostas=[];
const overlay=document.getElementById("overlay");
const fmt=v=>"R$ "+Number(v).toFixed(2).replace('.',',');

function showOverlay(msg="Carregando..."){overlay.style.display="flex";overlay.querySelector("p").textContent=msg;}
function hideOverlay(){overlay.style.display="none";}

/* ===== INDICADORES ===== */
function atualizarIndices(){
  const totalApostas=apostas.length;
  const valorTotal=apostas.reduce((t,a)=>t+a.qtd*PRECO,0);
  document.getElementById("totalApostas").textContent=totalApostas;
  document.getElementById("valorArrecadado").textContent=fmt(valorTotal);
  document.getElementById("premio").textContent=fmt(valorTotal*0.75);
  document.getElementById("lucro").textContent=fmt(valorTotal*0.25);
}

/* ===== RESULTADOS ===== */
function renderResultados(ganhadores,suspeitoCerto){
  const total=apostas.reduce((t,a)=>t+a.qtd*PRECO,0);
  const premio=total*0.75;
  const cotasTotais=ganhadores.reduce((s,g)=>s+g.qtd,0);
  const tbody=document.querySelector("#tabelaGanhadores tbody");
  tbody.innerHTML="";

  ganhadores.forEach(g=>{
    const valorInvest=g.qtd*PRECO;
    const valorReceber=(g.qtd/cotasTotais)*premio;
    const retorno=((valorReceber/valorInvest)-1)*100;
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${g.nome}</td>
      <td>${g.qtd}</td>
      <td>${fmt(valorInvest)}</td>
      <td>${fmt(valorReceber)}</td>
      <td>${retorno.toFixed(1)}%</td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById("resTotal").textContent=fmt(total);
  document.getElementById("resRepasses").textContent=fmt(premio);
  document.getElementById("resLucro").textContent=fmt(total*0.25);
  document.getElementById("resultadoFinal").style.display="block";
}

/* ===== TABELA ===== */
function renderTabela(){
  const tbody=document.querySelector("#tabelaApostas tbody");
  tbody.innerHTML="";
  apostas.forEach((a,i)=>{
    const tr=document.createElement("tr");
    const valorTotal=a.qtd*PRECO;
    const telefone=a.telefone.replace(/\D/g,'');
    const msg=`üéüÔ∏è *Resumo da sua aposta*\n\nüë§ *${a.nome}*\nüéØ Suspeito: *${a.foto}*\nüì¶ Cotas: *${a.qtd}*\nüí∞ Valor Total: *${fmt(valorTotal)}*\n\nAgradecemos por participar do bol√£o! üçÄ`;
    const linkWhats=`https://wa.me/55${telefone}?text=${encodeURIComponent(msg)}`;
    tr.innerHTML=`
      <td>${a.nome}</td>
      <td>${a.telefone}</td>
      <td>${a.foto}</td>
      <td>${a.qtd}</td>
      <td>${fmt(valorTotal)}</td>
      <td>${a.status}</td>
      <td>
        <button class="btn whats" onclick="window.open('${linkWhats}','_blank')">üì≤ WhatsApp</button>
        <button class="btn aprovar ${a.status==='APROVADO'?'done':''}" data-i="${i}">
          ${a.status==='APROVADO'?'‚úîÔ∏è':'Aprovar'}
        </button>
      </td>`;
    tbody.appendChild(tr);
  });

  document.querySelectorAll(".aprovar").forEach(btn=>{
    btn.addEventListener("click",async()=>{
      const i=btn.dataset.i;
      if(apostas[i].status==='APROVADO')return;
      showOverlay("Aprovando aposta...");
      apostas[i].status='APROVADO';
      btn.textContent='‚úîÔ∏è';
      btn.classList.add("done");
      atualizarIndices();renderGrafico();
      await fetch(SCRIPT_URL,{
        method:"POST",
        headers:{"Content-Type":"text/plain;charset=utf-8"},
        body:JSON.stringify({...apostas[i],action:"atualizarstatus"})
      });
      hideOverlay();
    });
  });
}

/* ===== GR√ÅFICO ===== */
let chart;
function renderGrafico(){
  const ctx=document.getElementById("chartApostas").getContext("2d");
  const contagem={};
  apostas.forEach(a=>{contagem[a.foto]=(contagem[a.foto]||0)+a.qtd;});
  const labels=Object.keys(contagem);
  const data=Object.values(contagem);
  if(chart)chart.destroy();
  chart=new Chart(ctx,{
    type:"bar",
    data:{labels,datasets:[{data,backgroundColor:"#f59e0b"}]},
    options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
  });

  // ===== Exemplo: Definir ganhadores (simulado)
  // substitua 'Maria' pelo suspeito certo
  const suspeitoCerto="Maria";
  const ganhadores=apostas.filter(a=>a.foto===suspeitoCerto && a.status==="APROVADO");
  if(ganhadores.length>0) renderResultados(ganhadores,suspeitoCerto);
}

/* ===== CARREGAR ===== */
async function carregar(){
  showOverlay();
  try{
    const r=await fetch(`${SCRIPT_URL}?action=listar`,{cache:"no-store"});
    const j=await r.json();
    apostas=j.map(l=>({
      nome:l.nome,email:l.email,telefone:l.telefone,
      foto:l.foto,qtd:Number(l.qtd),status:l.status
    }));
    atualizarIndices();
    renderTabela();
    renderGrafico();
  }catch(e){console.error(e);}
  finally{hideOverlay();}
}
carregar();
</script>
</body>
</html>
